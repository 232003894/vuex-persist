{"version":3,"file":"index.js","sources":["../src/MockStorage.ts","../src/index.ts"],"sourcesContent":["/**\n * Created by championswimmer on 22/07/17.\n */\nexport default class MockStorage implements Storage {\n  [index: number]: string;\n  [key: string]: any;\n\n  public get length(): number {\n    return Object.keys(this).length\n  }\n\n  public key(index: number): string | any {\n    return Object.keys(this)[index]\n  }\n\n  public setItem(key: string, data: any): void {\n    this[key] = data.toString()\n  }\n  public getItem(key: string): string {\n    return this[key]\n  }\n  public removeItem(key: string): void {\n    delete this[key]\n  }\n  public clear(): void {\n    for (const key of Object.keys(this)) {\n      delete this[key]\n    }\n  }\n}\n","/**\n * Created by championswimmer on 18/07/17.\n */\nimport {Mutation, Payload, Plugin, Store} from 'vuex'\nimport MockStorage from './MockStorage'\nimport merge from 'lodash.merge'\n/**\n * Options to be used to construct a {@link VuexPersistence} object\n */\nexport interface PersistOptions<S> {\n  /**\n   * Window.Storage type object. Default is localStorage\n   */\n  storage?: Storage | any\n\n  /**\n   * Method to retrieve state from persistence\n   * @param key\n   * @param [storage]\n   */\n  restoreState?: (key: string, storage?: Storage) => (S | Promise<S>)\n\n  /**\n   * Method to save state into persistence\n   * @param key\n   * @param state\n   * @param [storage]\n   */\n  saveState?: (key: string, state: {}, storage?: Storage) => (void | Promise<void>)\n\n  /**\n   * Function to reduce state to the object you want to save.\n   * Be default, we save the entire state.\n   * You can use this if you want to save only a portion of it.\n   * @param state\n   */\n  reducer?: (state: S) => {}\n\n  /**\n   * Key to use to save the state into the storage\n   */\n  key?: string\n\n  /**\n   * Method to filter which mutations will trigger state saving\n   * Be default returns true for all mutations.\n   * Check mutations using <code>mutation.type</code>\n   * @param mutation object of type {@link Payload}\n   */\n  filter?: (mutation: Payload) => boolean\n\n  /**\n   * Names of modules that you want to persist.\n   * If you create your custom {@link PersistOptions.reducer} function,\n   * then that will override filter behaviour, not this argument\n   */\n  modules?: string[]\n\n  /**\n   * Set this to true to support\n   * <a href=\"https://vuex.vuejs.org/en/strict.html\">Vuex Strict Mode</a>\n   */\n  strictMode?: boolean\n}\n\n/**\n * A class that implements the vuex persistence.\n */\nexport class VuexPersistence<S, P extends Payload> implements PersistOptions<S> {\n  public storage: Storage | any\n  public restoreState: (key: string, storage?: Storage) => (S | Promise<S>)\n  public saveState: (key: string, state: {}, storage?: Storage) => (void | Promise<void>)\n  public reducer: (state: S) => {}\n  public key: string\n  public filter: (mutation: Payload) => boolean\n  public modules: string[]\n  public strictMode: boolean\n\n  /**\n   * The plugin function that can be used inside a vuex store.\n   */\n  public plugin: Plugin<S>\n  /**\n   * A mutation that can be used to restore state\n   * Helpful if we are running in strict mode\n   */\n  public RESTORE_MUTATION: Mutation<S>\n  /**\n   * Create a {@link VuexPersistence} object.\n   * Use the <code>plugin</code> function of this class as a\n   * Vuex plugin.\n   * @param {PersistOptions} options\n   */\n  public constructor(options: PersistOptions<S>) {\n    this.key = ((options.key != null) ? options.key : 'vuex')\n    this.storage = (\n      (options.storage != null)\n        ? options.storage\n        : (new MockStorage())\n    )\n    this.restoreState = (\n      (options.restoreState != null)\n        ? options.restoreState\n        : (async (key: string, storage?: Storage) =>\n            JSON.parse(await (storage || this.storage).getItem(key) || '{}')\n        )\n    )\n    this.saveState = (\n      (options.saveState != null)\n        ? options.saveState\n        : (async (key: string, state: {}, storage?: Storage) =>\n          await (storage || this.storage).setItem(key, JSON.stringify(state)))\n    )\n    /**\n     * How this works is -\n     *  1. If there is options.reducer function, we use that, if not;\n     *  2. We check options.modules;\n     *    1. If there is no options.modules array, we use entire state in reducer\n     *    2. Otherwise, we create a reducer that merges all those state modules that are\n     *        defined in the options.modules[] array\n     * @type {((state: S) => {}) | ((state: S) => S) | ((state: any) => {})}\n     */\n    this.reducer = (\n      (options.reducer != null)\n        ? options.reducer\n        : (\n          (options.modules == null)\n            ? ((state: S) => state)\n            : (\n              (state: any) =>\n                (<string[]> options.modules).reduce((a, i) =>\n                  merge(a, { [i]: state[i] }), {})\n            )\n        )\n    )\n    this.filter = (\n      (options.filter != null)\n        ? options.filter\n        : ((mutation) => true)\n    )\n\n\n    this.strictMode = options.strictMode || false\n\n    this.RESTORE_MUTATION = function RESTORE_MUTATION (state: S, savedState: any) {\n      state = merge(state, savedState)\n    }\n\n    this.plugin = async (store: Store<S>) => {\n      const savedState = await this.restoreState(this.key, this.storage)\n      /**\n       * If in strict mode, do only via mutation\n       */\n      if (this.strictMode) {\n        store.commit('RESTORE_MUTATION', savedState)\n      } else {\n        store.replaceState(merge(store.state, savedState))\n      }\n\n      this.subscriber(store)(async (mutation: P, state: S) => {\n        if (this.filter(mutation)) {\n          await this.saveState(this.key, this.reducer(state), this.storage)\n        }\n      })\n    }\n  }\n\n  /**\n   * Creates a subscriber on the store. automatically is used\n   * when this is used a vuex plugin. Not for manual usage.\n   * @param store\n   */\n  private subscriber = (store: Store<S>) =>\n    (handler: (mutation: P, state: S) => any) => store.subscribe(handler)\n\n}\n\nexport {\n  MockStorage\n}\n\nexport default VuexPersistence\n"],"names":[],"mappings":"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"}